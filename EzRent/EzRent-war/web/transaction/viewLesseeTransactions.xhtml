<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="./../template/defaultTemplate.xhtml"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:define name="content">
        <ez:Breadcrumb pageName="ViewLesseeTransactions" />

        <div>
            <h3>View All Pending Offers</h3>
            <h4>Offers that you have made and are awaiting confirmation from listing owner.</h4>

            <h:form id="formAllPendingOffers">
                <p:messages id="messages" redisplay="false" closable="true" />

                <p:dataTable id="dataTableAllPendingOffers" widgetVar="dataTableAllPendingOffers" value="#{viewLesseeTransactionsManagedBean.pendingOffersMade}" var="offer" rowKey="#{offer.offerId}" rowIndexVar="row"
                             rows="10" paginator="true" paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" rowsPerPageTemplate="10,20,50">

                    <p:column headerText="Offer ID" sortBy="#{offer.offerId}" filterBy="#{offer.offerId}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{offer.offerId}" />
                    </p:column>
                    
                    <p:column headerText="Item" sortBy="#{offer.listing.listingName}" filterBy="#{offer.listing.listingName}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{offer.listing.listingName}" />
                    </p:column>

                    <p:column headerText="Date offered" sortBy="#{offer.dateOffered}" filterBy="#{offer.dateOffered}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{viewLesseeTransactionsManagedBean.displayTime(offer.dateOffered)}" />
                    </p:column>                            

                    <p:column headerText="Rental start date" sortBy="#{offer.rentalStartDate}" filterBy="#{offer.rentalStartDate}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{viewLesseeTransactionsManagedBean.displayTime(offer.rentalStartDate)}" />
                    </p:column>

                    <p:column headerText="Rental end date" sortBy="#{offer.rentalEndDate}" filterBy="#{offer.rentalEndDate}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{viewLesseeTransactionsManagedBean.displayTime(offer.rentalEndDate)}" />
                    </p:column>

                    <p:column headerText="Offer status" sortBy="#{offer.offerStatus}" filterBy="#{offer.offerStatus}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{offer.offerStatus}" />
                    </p:column>

                    <p:column headerText="Action" style="background-color: #E6F2FE !important;">
                        <p:commandButton actionListener="#{viewLesseeTransactionsManagedBean.deleteOwnOffer}" rendered="#{offer.offerStatus == 'ONGOING'}" update="formAllPendingOffers:dataTableAllPendingOffers formAllPendingOffers:messages" value="Cancel Offer" title="Cancel Offer">
                            <f:attribute name="selectedOffer" value="#{offer}" />
                            <p:confirm header="Confirmation" message="Are you sure you want to delete offer #{offer.offerId}? This action cannot be undone." icon="ui-icon-alert" />
                        </p:commandButton>
                    </p:column>
                </p:dataTable>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <div style="text-align: center;">
                        <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check"/>
                        <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close"/>
                    </div>
                </p:confirmDialog>
            </h:form>

        </div>
        <div>

            <h3>View Ongoing Transactions</h3>

            <h:form id="formViewAllTransactions">
                <p:messages id="messages" redisplay="false" closable="true" />

                <p:dataTable id="dataTableAllTransactions" widgetVar="dataTableAllTransactions" value="#{viewLesseeTransactionsManagedBean.transactions}" var="transaction" rowKey="#{transaction.transactionId}" rowIndexVar="row"
                             rows="10" paginator="true" paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}" rowsPerPageTemplate="10,20,50"
                             sortMode="single">

                    <p:column headerText="Transaction ID" sortBy="#{transaction.transactionId}" filterBy="#{transaction.transactionId}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{transaction.transactionId}" />
                    </p:column>

                    <p:column headerText="Start Date" sortBy="#{transaction.transactionStartDate}" filterBy="#{transaction.transactionStartDate}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{viewLesseeTransactionsManagedBean.displayTime(transaction.transactionStartDate)}" />
                    </p:column>                            

                    <p:column headerText="End Date" sortBy="#{transaction.transactionEndDate}" filterBy="#{transaction.transactionEndDate}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{viewLesseeTransactionsManagedBean.displayTime(transaction.transactionEndDate)}" />
                    </p:column>

                    <p:column headerText="Transaction status" sortBy="#{transaction.transactionStatus}" filterBy="#{transaction.transactionStatus}" filterMatchMode="contains" style="background-color: #E6F2FE !important;">
                        <h:outputText value="#{viewLesseeTransactionsManagedBean.retrieveStatus(event, transaction)}" />
                    </p:column>

                    <p:column headerText="Action" style="background-color: #E6F2FE !important;">
                        <p:commandButton actionListener="#{viewLesseeTransactionsManagedBean.setTransaction}" update="formMakePaymentAndDelivery" oncomplete="PF('dialogMakePaymentAndDelivery').show()" rendered="#{transaction.payment == null || (transaction.payment.modeOfPayment == 'CREDIT_CARD' &amp;&amp; transaction.payment.paymentStatus == 'UNPAID') || (transaction.offer.listing.deliveryOption == 'MAIL' &amp;&amp; transaction.delivery == null)}" value="Confirm details" title="Confirm details">
                            <f:attribute name="selectedTransaction" value="#{transaction}" />
                        </p:commandButton>

                        <!-- Maybe: can have button to link to chat to talk to lessor -->

                        <p:commandButton actionListener="#{viewLesseeTransactionsManagedBean.markTransactionAsReceived}" 
                                         rendered="#{transaction.transactionStatus != 'RECEIVED' &amp;&amp; transaction.transactionStatus != 'COMPLETED' &amp;&amp; (transaction.offer.listing.deliveryOption == 'MEETUP' &amp;&amp; (transaction.transactionStatus == 'PAID' || transaction.offer.listing.modeOfPayment == 'CASH_ON_DELIVERY')) || (transaction.offer.listing.deliveryOption == 'MAIL' &amp;&amp; (transaction.delivery != null &amp;&amp; (transaction.transactionStatus == 'PAID' || transaction.offer.listing.modeOfPayment == 'CASH_ON_DELIVERY')))}" 
                                         update="formViewAllTransactions:dataTableAllTransactions formViewAllTransactions:messages" value="Received" title="Received">
                            <f:attribute name="selectedTransaction" value="#{transaction}" />
                        </p:commandButton>

                    </p:column>
                </p:dataTable>

            </h:form>

            <h:form id="formMakePaymentAndDelivery">
                <p:dialog id="dialogMakePaymentAndDelivery" widgetVar="dialogMakePaymentAndDelivery" header="Payment and delivery" closable="true">

                    <p:messages id="messagesMakePaymentAndDelivery" redisplay="false" />

                    <p:panelGrid>


                        <p:row rendered="#{viewLesseeTransactionsManagedBean.selectedTransaction.payment == null || (viewLesseeTransactionsManagedBean.selectedTransaction.payment.modeOfPayment == 'CREDIT_CARD' &amp;&amp; viewLesseeTransactionsManagedBean.selectedTransaction.payment.paymentStatus == 'UNPAID')}">
                            <p:column>
                                <p:outputLabel for="ccNumber" value="Credit card id: " style="font-weight: bold;" />
                            </p:column>
                            <p:column>
                                <p:inputText id="ccNumber" value="#{viewLesseeTransactionsManagedBean.creditCardId}" required="true" requiredMessage="Credit card id is required" />
                            </p:column>
                        </p:row>

                        <p:row rendered="#{viewLesseeTransactionsManagedBean.selectedTransaction.offer.listing.deliveryOption == 'MAIL'}">
                            <p:column>
                                <p:outputLabel for="streetName" value="Street name: " style="font-weight: bold;" />
                            </p:column>
                            <p:column>
                                <p:inputText id="streetName" value="#{viewLesseeTransactionsManagedBean.newStreetName}" required="true" requiredMessage="Street name is required" />
                            </p:column>
                        </p:row>

                        <p:row rendered="#{viewLesseeTransactionsManagedBean.selectedTransaction.offer.listing.deliveryOption == 'MAIL'}">
                            <p:column>
                                <p:outputLabel for="postalCode" value="Postal code: " style="font-weight: bold;" />
                            </p:column>
                            <p:column>
                                <p:inputText id="postalCode" value="#{viewLesseeTransactionsManagedBean.newPostalCode}" required="true" requiredMessage="Postal code is required" />
                            </p:column>
                        </p:row>

                        <p:row>
                            <p:column colspan="2">
                                <p:commandButton value="Confirm details" update="formViewAllTransactions:dataTableAllTransactions formViewAllTransactions:messages" actionListener="#{viewLesseeTransactionsManagedBean.makePaymentAndDelivery}" oncomplete="PF('dialogMakePaymentAndDelivery').hide();" />
                            </p:column>
                        </p:row>

                    </p:panelGrid>

                </p:dialog>
            </h:form>
        </div>
    </ui:define>

</ui:composition>
